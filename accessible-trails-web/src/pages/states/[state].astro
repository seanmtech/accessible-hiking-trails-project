---
import Layout from '../../layouts/Layout.astro';
import LocationCard from '../../components/LocationCard.astro';
import FilterPanel from '../../components/FilterPanel.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import AdSlot from '../../components/AdSlot.astro';
import parksData from '../../../../data/parks.json';
import type { Park } from '../../types';

export async function getStaticPaths() {
  const parks = parksData as Park[];
  // Extract unique states. Some parks have multiple states "WY,MT,ID"
  const allStates = new Set<string>();
  
  parks.forEach(park => {
    const parkStates = park.state.split(',').map(s => s.trim());
    parkStates.forEach(s => allStates.add(s));
  });

  return Array.from(allStates).map(state => ({
    params: { state },
    props: { 
      stateName: state,
      parks: parks.filter(p => p.state.includes(state))
    }
  }));
}

const { stateName, parks } = Astro.props;

const breadcrumbs = [
  { name: 'Home', href: '/' },
  { name: stateName, href: `/states/${stateName}`, current: true }
];

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `Accessible Parks in ${stateName}`,
  "description": `List of wheelchair accessible parks and trails in ${stateName}.`,
  "url": Astro.url.href,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": parks.map((park, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": new URL(`/location/${park.id}`, Astro.url).href,
      "name": park.name
    }))
  }
};
---

<Layout title={`Accessible Parks in ${stateName}`} showSidebar={true}>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <div slot="sidebar" class="space-y-8">
    <div class="sticky top-24">
      <FilterPanel />
      <div class="mt-8">
        <AdSlot id={`sidebar-ad-${stateName}`} format="vertical" />
      </div>
    </div>
  </div>

  <div class="mb-6">
    <Breadcrumbs items={breadcrumbs} />
    <h1 class="text-3xl font-bold text-gray-900 mt-4">Accessible Parks in {stateName}</h1>
    <p class="text-gray-600 mt-2">Found {parks.length} locations</p>
  </div>

  <div class="space-y-6" id="parks-list">
    {parks.map((park, index) => (
      <>
        <div 
          class="park-item" 
          data-restrooms={park.accessible_restrooms}
          data-parking={park.accessible_parking}
          data-trails={park.accessible_trails}
        >
          <LocationCard park={park} />
        </div>
        {(index + 1) % 5 === 0 && (
           <div class="my-8">
             <AdSlot id={`in-feed-ad-${index}`} format="horizontal" />
           </div>
        )}
      </>
    ))}
  </div>
    
  <div id="no-results" class="hidden text-center py-12 text-gray-500">
      <p class="text-lg">No parks match your selected filters.</p>
      <button id="clear-filters" class="mt-4 text-green-600 hover:underline">Clear filters</button>
  </div>
</Layout>

<script>
  function filterParks() {
    const urlParams = new URLSearchParams(window.location.search);
    const requireRestrooms = urlParams.has('accessible_restrooms');
    const requireParking = urlParams.has('accessible_parking');
    const requireTrails = urlParams.has('accessible_trails');

    const parkItems = document.querySelectorAll('.park-item');
    let visibleCount = 0;

    parkItems.forEach((item) => {
      const el = item as HTMLElement;
      const hasRestrooms = el.dataset.restrooms === 'true';
      const hasParking = el.dataset.parking === 'true';
      const hasTrails = el.dataset.trails === 'true';

      let isVisible = true;
      if (requireRestrooms && !hasRestrooms) isVisible = false;
      if (requireParking && !hasParking) isVisible = false;
      if (requireTrails && !hasTrails) isVisible = false;

      if (isVisible) {
        el.style.display = 'block';
        visibleCount++;
      } else {
        el.style.display = 'none';
      }
    });

    const noResults = document.getElementById('no-results');
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }

  // Run on load
  filterParks();

  // Handle clear filters button
  document.getElementById('clear-filters')?.addEventListener('click', () => {
    window.location.search = '';
  });
</script>
